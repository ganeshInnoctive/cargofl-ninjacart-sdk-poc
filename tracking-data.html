<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>SIM Tracking</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/bootstrap-datetimepicker/bootstrap-datetimepicker.min.css">

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"></script>
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBu-916DdpKAjTmJNIgngS6HL_kDIKU0aU&callback=myMap"></script>
    <script src="js/index.js"></script>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" type="text/css" href="css/bootstrap-table.min.css">
    <link rel="stylesheet" type="text/css" href="css/bootstrap-table.css">

    <script src="js/bootstrap-table.min.js"></script>
    <script src="js/jquery/jquery.js"></script>
    <script src="js/bootstrap-table.js"></script>
    <script src="js/urls.js"></script>
    <script src="js/config.js"></script>
    <script src="js/error_messages.js"></script>
    <script src="js/success_messages.js"></script>
    <script src="js/constants.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
        integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
        crossorigin="" />

    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
        integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
        crossorigin=""></script>

    <style>
        #mapid {
            height: 770px;
        }
    </style>
</head>

<body>
    <main class="main-container">
        <section class="p-2 p-md-3 p-lg-5">
            <div class="container">
                <div class="row no-gutters justify-content-center">
                    <div class="col-12 col-lg-10">
                        <div class="row no-gutters">
                            <div class="col-12 col-lg-12">
                                <h1 class="tx-bold tx-center header-title">Tracking Data</h1>
                            </div>
                            <div class="col-12 col-lg-12 my-2 my-lg-4 my-xl-5">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <div class="tx-semibold">From Date <input type="text" id="startDateTime"
                                                name="startDateTime" placeholder="Select date"
                                                class="form-control date-time-picker" readonly /></div>
                                        <div class="tx-semibold tx-right">To Date <input type="text" id="endDateTime"
                                                name="endDateTime" placeholder="Select date"
                                                class="form-control date-time-picker" readonly /></div>
                                    </div>
                                    <div class="card-body">
                                        <div class="row no-gutters">
                                            <div class="col-12 col-lg-12">
                                                <div id="map-div">
                                                    <div id="mapid"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script src="js/moment/moment.min.js"></script>
    <script src="js/bootstrap-datetimepicker/bootstrap-datetimepicker.min.js"></script>

    <script>
        $(document).ready(function (e) {
            // Set DateTimePicker
            $('.date-time-picker').datetimepicker({
                format: 'dd-mm-yyyy hh:ii',
                clearBtn: true,
                autoclose: true,
            });

            let currentDateTimeInEpoch = moment().valueOf()
            let twoDaysBeforeCurrentDateTimeInEpoch = moment().subtract(2, 'days').valueOf()

            var mobileNumber = ""

            let urlParams = new URLSearchParams(window.location.search)
            if (urlParams.has('mobile_number')) {
                mobileNumber = urlParams.get('mobile_number')
            }

            if (mobileNumber != "" && mobileNumber != null) {
                getTrackingDetails(mobileNumber, currentDateTimeInEpoch, twoDaysBeforeCurrentDateTimeInEpoch)
            } else {
                alert('Mobile number is mandatory for tracking user')
            }

            var startDateTime = ""
            var endDateTime = ""

            $("#startDateTime").change(function (e) {
                let startDateTime = $('#startDateTime').val();
                let endDateTime = $('#endDateTime').val();

                if (mobileNumber == "" || mobileNumber == null) {
                    alert('Mobile number is mandatory for tracking user')
                }

                if (startDateTime != null && startDateTime != "" && endDateTime != null && endDateTime != "") {
                    let startDateTimeInEpoch = convertDateTimeStringToEpoch(startDateTime)
                    let endDateTimeInEpoch = convertDateTimeStringToEpoch(endDateTime)

                    getTrackingDetails(mobileNumber, startDateTime, endDateTime)
                }
            });

            $("#endDateTime").change(function (e) {
                let startDateTime = $('#startDateTime').val();
                let endDateTime = $('#endDateTime').val();

                if (mobileNumber == "" || mobileNumber == null) {
                    alert('Mobile number is mandatory for tracking user')
                }

                if (startDateTime != null && startDateTime != "" && endDateTime != null && endDateTime != "") {
                    let startDateTimeInEpoch = convertDateTimeStringToEpoch(startDateTime)
                    let endDateTimeInEpoch = convertDateTimeStringToEpoch(endDateTime)

                    getTrackingDetails(mobileNumber, startDateTimeInEpoch, endDateTimeInEpoch)
                }
            });

        });

        function convertDateTimeStringToEpoch(dateTime) {
            return moment(dateTime, "dd-mm-yyyy hh:ii").valueOf()
        }

        function getTrackingDetails(mobileNumber, startDateTime, stopDateTime) {
            $.ajax({
                type: "POST",
                url: "https://mt-test.cargofl.com/api/v1/sim_tracking/get-sim-tracking-location-details",
                data: JSON.stringify({
                    "mobile_number": mobileNumber,
                    "startTime": startDateTime,
                    "stopTime": stopDateTime
                }),
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                success: function (response) {
                    if (response['data'].length > 0) {
                        ajax_response = JSON.stringify(response.data);
                        var gps_data = JSON.parse(ajax_response);
                        view_map_view(gps_data)
                    } else {
                        alert("No data found for selected date time")
                    }
                }
            });
        }

        function view_map_view(gps_data) {


            Lat = 18.5204;
            Lon = 73.8567;

            var a = [];
            $.each(gps_data, function (index, data) {
                a.push({ "lat": data.latitude, "lng": data.longitude, "address": data.address + ", Date - " + data.date_time, "location_number": (index + 1).toString() });
            });

            // If location details present then set default lat long as a first location
            if (a.length >= 1) {
                Lat = a[0].lat;
                Lon = a[0].lng;
            }

            $('#mapid').remove(); // this is <canvas> element
            $('#map-div').append('<div id="mapid"></div>');

            // Create map view
            var mymap = L.map('mapid').setView([Lat, Lon], 11);

            L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mymap);

            $('#templateModal_map_View').on('shown.bs.modal', function () {
                mymap.invalidateSize();
            });

            // Create marker with different colour
            var greenIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                iconSize: [40, 65]
            });

            var redIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                iconSize: [40, 65]
            });

            var blueIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                iconSize: [30, 55]
            });


            for (i = 0; i < a.length; i++) {
                // If first location, then set colour as green
                if (i == 0) {
                    // Add address as title and bindtooltp for showing location sequentially
                    var marker = L.marker([a[i].lat, a[i].lng],
                        {
                            title: a[i].address,
                            icon: greenIcon
                        },

                    ).bindTooltip(a[i].location_number,
                        {
                            permanent: true,
                            direction: 'right'
                        })
                        .addTo(mymap);
                }
                // If last location, then set colour as red
                else if (i == a.length - 1) {
                    // Add address as title and bindtooltp for showing location sequentially
                    var marker = L.marker([a[i].lat, a[i].lng],
                        {
                            title: a[i].address,
                            icon: redIcon
                        },
                    ).bindTooltip(a[i].location_number,
                        {
                            permanent: true,
                            direction: 'right'
                        })
                        .addTo(mymap);

                }
                // Set colour as blue for remaining markers
                else {
                    // Add address as title and bindtooltp for showing location sequentially
                    var marker = L.marker([a[i].lat, a[i].lng],
                        {
                            title: a[i].address,
                            icon: blueIcon
                        },
                    ).bindTooltip(a[i].location_number,
                        {
                            permanent: true,
                            direction: 'right'
                        })
                        .addTo(mymap);

                }
            }

            // Function to connect then ping points
            function connectTheDots(data) {
                var c = [];
                for (i = 0; i < a.length; i++) {
                    var x = a[i].lat;
                    var y = a[i].lng;
                    c.push([x, y]);
                }
                return c;
            }
            // connect location points with polyline
            pathCoords = connectTheDots(window.geojson);
            var pathLine = L.polyline(pathCoords).addTo(mymap);

        }
    </script>
</body>

</html>