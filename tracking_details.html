<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>SIM Tracking</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" type="text/css" href="css/spinner.css">
    <link rel="stylesheet" href="css/bootstrap-datetimepicker/bootstrap-datetimepicker.min.css">

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"></script>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" type="text/css" href="css/bootstrap-table.min.css">
    <link rel="stylesheet" type="text/css" href="css/bootstrap-table.css">

    <script src="js/bootstrap-table.min.js"></script>
    <script src="js/jquery/jquery.js"></script>
    <script src="js/bootstrap-table.js"></script>
    <script src="js/urls.js"></script>
    <script src="js/config.js"></script>
    <script src="js/error_messages.js"></script>
    <script src="js/essential_methods.js"></script>
    <script src="js/success_messages.js"></script>
    <script src="js/constants.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
        integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
        crossorigin="" />

    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
        integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
        crossorigin=""></script>

    <style>
        #mapid {
            height: 770px;
        }
    </style>
</head>

<body>
    <div id="spinner">
        <img src="images/loader.gif" />
    </div>

    <main class="main-container">
        <section class="p-2 p-md-3 p-lg-5">
            <div class="container">
                <div class="row no-gutters justify-content-center">
                    <div class="col-12 col-lg-10">
                        <div class="row no-gutters">
                            <div class="col-12 col-lg-12">
                                <button class="btn btn-primary"
                                    onclick="window.history.go(-1); return false;">Back</button>
                                <h1 class="tx-bold tx-center header-title">SIM Tracking</h1>
                            </div>
                            <div class="col-12 col-lg-12 my-2 my-lg-4 my-xl-5">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <div class="tx-semibold">From Date <input type="text" id="startDateTime"
                                                name="startDateTime" placeholder="Select date"
                                                class="form-control date-time-picker" readonly /></div>
                                        <div class="tx-semibold tx-right">To Date <input type="text" id="endDateTime"
                                                name="endDateTime" placeholder="Select date"
                                                class="form-control date-time-picker" readonly /></div>
                                    </div>
                                    <div class="card-body">
                                        <div class="row no-gutters">
                                            <div class="col-12 col-lg-12">
                                                <div id="map-div">
                                                    <div id="mapid"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script src="js/moment/moment.min.js"></script>
    <script src="js/bootstrap-datetimepicker/bootstrap-datetimepicker.min.js"></script>

    <script>
        var mobileNumber = "", token = "";

        $(document).ready(function (e) {
            // Set DateTimePicker
            $('.date-time-picker').datetimepicker({
                format: 'dd-mm-yyyy hh:ii',
                clearBtn: true,
                autoclose: true,
            });

            let currentDateTimeInEpoch = moment().valueOf()
            let twoDaysBeforeCurrentDateTimeInEpoch = moment().subtract(2, 'days').valueOf()

            var end_location_lat = "", end_location_long = "";

            let urlParams = new URLSearchParams(window.location.search)
            if (urlParams.has('mobile_number')) {
                mobileNumber = urlParams.get('mobile_number')
            }
            if (urlParams.has('end_location_lat')) {
                endLocationLat = urlParams.get('end_location_lat')
            }
            if (urlParams.has('end_location_long')) {
                endLocationLong = urlParams.get('end_location_long')
            }

            if (mobileNumber == "" || mobileNumber == null) {
                alert('Mobile number is mandatory for tracking user')
            } else if (endLocationLat == "" || endLocationLat == null || endLocationLong == "" || endLocationLong == null) {
                alert('End location is mandatory for stopping tracking for a user')
            }

            var startDateTime = ""
            var endDateTime = ""

            $("#startDateTime").change(function (e) {
                let startDateTime = $('#startDateTime').val();
                let endDateTime = $('#endDateTime').val();

                if (mobileNumber == "" || mobileNumber == null) {
                    alert('Mobile number is mandatory for tracking user')
                }

                if (startDateTime != null && startDateTime != "" && endDateTime != null && endDateTime != "") {
                    let startDateTimeInEpoch = convertDateTimeStringToEpoch(startDateTime)
                    let endDateTimeInEpoch = convertDateTimeStringToEpoch(endDateTime)

                    getTrackingDetails(mobileNumber, startDateTimeInEpoch, endDateTimeInEpoch)
                }
            });

            $.ajax({
                type: "POST",
                url: BASE_URL + ENDPOINT_GENERATE_AUTH_TOKEN,
                data: JSON.stringify({
                    "username": FLEETOS_USERNAME,
                    "password": FLEETOS_PASSWORD
                }),
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                beforeSend: function () {
                    showLoader()
                },
                success: function (response) {
                    hideLoader()

                    if (response == null) {
                        alert(ERROR_RESPONSE_NULL)
                    } else if (response['auth_token'] == null || response['auth_token'] == "") {
                        alert(ERROR_TOKEN_EMPTY)
                    } else {
                        if (response['code'] == API_SUCCESS_CODE) {
                            token = response['auth_token']

                            get_driver_details_from_fleetos(mobileNumber, token)
                        } else {
                            if (response['responseJSON']['message'] != null && response['responseJSON']['message'] != "") {
                                alert(response['responseJSON']['message'])
                            } else {
                                alert(ERROR_GENERATING_AUTH_TOKEN)
                            }
                        }
                    }
                },
                error: function (response) {
                    hideLoader()

                    if (response != null && response['responseJSON']['message'] != null && response['responseJSON']['message'] != "") {
                        alert(response['responseJSON']['message'])
                    } else {
                        alert(ERROR_GENERATING_AUTH_TOKEN)
                    }
                }
            });

            function get_driver_details_from_fleetos(driver_mobile_number, token) {
                $.ajax({
                    type: "GET",
                    beforeSend: function (request) {
                        request.setRequestHeader("Authorization", "bearer " + token);
                        showLoader()
                    },
                    url: BASE_URL + ENDPOINT_GET_USER_DETAILS_FROM_FLEETOS + driver_mobile_number,
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    success: function (response) {
                        hideLoader()

                        if (response == null) {
                            alert(ERROR_RESPONSE_NULL)
                        } else {
                            if (response['code'] == API_SUCCESS_CODE) {
                                if (response['data']['simConsent'] == 'N') {
                                    alert(response['data']['simConsentMsg'])
                                    getTrackingDetails(mobileNumber, twoDaysBeforeCurrentDateTimeInEpoch, currentDateTimeInEpoch, token)
                                }
                                else {
                                    getTrackingDetails(mobileNumber, twoDaysBeforeCurrentDateTimeInEpoch, currentDateTimeInEpoch, token)
                                }
                            } else {
                                if (response['responseJSON']['message'] != null && response['responseJSON']['message'] != "") {
                                    alert(response['responseJSON']['message'])
                                } else {
                                    alert(ERROR_GETTING_DRIVER_ID)
                                }
                            }
                        }
                    },
                    error: function (response) {
                        hideLoader()

                        if (response['responseJSON']['message'] != null && response['responseJSON']['message'] != "") {
                            alert(response['responseJSON']['message'])
                        } else {
                            alert(ERROR_GETTING_DRIVER_ID)
                        }
                    }
                });
            }


            $("#endDateTime").change(function (e) {
                let startDateTime = $('#startDateTime').val();
                let endDateTime = $('#endDateTime').val();

                if (mobileNumber == "" || mobileNumber == null) {
                    alert('Mobile number is mandatory for tracking user')
                }

                if (startDateTime != null && startDateTime != "" && endDateTime != null && endDateTime != "") {
                    let startDateTimeInEpoch = convertDateTimeStringToEpoch(startDateTime)
                    let endDateTimeInEpoch = convertDateTimeStringToEpoch(endDateTime)

                    getToken(mobileNumber, startDateTimeInEpoch, endDateTimeInEpoch)
                }
            });

        });

        function getToken(mobileNumber, startDateTimeInEpoch, endDateTimeInEpoch) {
            $.ajax({
                type: "POST",
                url: BASE_URL + ENDPOINT_GENERATE_AUTH_TOKEN,
                data: JSON.stringify({
                    "username": FLEETOS_USERNAME,
                    "password": FLEETOS_PASSWORD
                }),
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                beforeSend: function () {
                    showLoader()
                },
                success: function (response) {
                    hideLoader()

                    if (response == null) {
                        alert(ERROR_RESPONSE_NULL)
                    } else if (response['auth_token'] == null || response['auth_token'] == "") {
                        alert(ERROR_TOKEN_EMPTY)
                    } else {
                        if (response['code'] == API_SUCCESS_CODE) {
                            token = response['auth_token']

                            if (mobileNumber != null && mobileNumber != "" && startDateTimeInEpoch != null && endDateTimeInEpoch != null) {
                                getTrackingDetails(mobileNumber, startDateTimeInEpoch, endDateTimeInEpoch, token);
                            } else {
                                stopTracking();
                            }
                        } else {
                            if (response['responseJSON']['message'] != null && response['responseJSON']['message'] != "") {
                                alert(response['responseJSON']['message'])
                            } else {
                                alert(ERROR_GENERATING_AUTH_TOKEN)
                            }
                        }
                    }
                },
                error: function (response) {
                    hideLoader()

                    if (response != null && ['responseJSON']['message'] != null && response['responseJSON']['message'] != "") {
                        alert(response['responseJSON']['message'])
                    } else {
                        alert(ERROR_GENERATING_AUTH_TOKEN)
                    }
                }
            });
        }

        function convertDateTimeStringToEpoch(dateTime) {
            // This complicated piece of regex is required because JavaScript dates are internally stored as milliseconds since epoch.
            //  You just need to convert it to a number, e.g. with the unary + operator, to get them
            var parts = dateTime.match(/(\d{2})-(\d{2})-(\d{4}) (\d{2}):(\d{2})/);
            return Date.UTC(+parts[3], parts[2] - 1, +parts[1], +parts[4], +parts[5]);
        }

        function getTrackingDetails(mobileNumber, startDateTime, stopDateTime, token) {
            $.ajax({
                type: "GET",
                url: BASE_URL + ENDPOINT_GET_USER_LOCATION_HISTORY,
                data: {
                    "mobile_number": mobileNumber,
                    "start_time": startDateTime,
                    "stop_time": stopDateTime
                },
                beforeSend: function (request) {
                    request.setRequestHeader("Authorization", "bearer " + token);
                    showLoader()
                },
                success: function (response) {
                    hideLoader()
                    if (response['data'].length > 0) {
                        ajax_response = JSON.stringify(response.data);
                        var gps_data = JSON.parse(ajax_response);
                        view_map_view(gps_data)
                    } else {
                        alert("No data found for selected date time")
                    }
                },
                error: function (response) {
                    hideLoader()
                    if (response['responseJSON']['message'] != null && response['responseJSON']['message'] != "") {
                        alert(response['responseJSON']['message'])
                    } else {
                        alert(ERROR_GETTING_TRACKING_DETAILS)
                    }
                }
            });
        }

        function view_map_view(gps_data) {
            let markers = [];
            let flightPlanCoordinates = [];
            let bounds = new google.maps.LatLngBounds();

            Lat = 18.5204;
            Lon = 73.8567;

            var pinged_locations = [];
            $.each(gps_data, function (index, data) {
                pinged_locations.push({ "lat": data.latitude, "lng": data.longitude, "address": data.address });
                flightPlanCoordinates.push(new google.maps.LatLng(parseFloat(data.latitude), parseFloat(data.longitude)))
            });


            // If location details present then set default lat long as a first location
            if (pinged_locations.length >= 1) {
                Lat = pinged_locations[0].lat;
                Lon = pinged_locations[0].lng;
            }

            $('#mapid').remove(); // this is <canvas> element
            $('#map-div').append('<div id="mapid"></div>');

            // Create map view
            map = new google.maps.Map(document.getElementById("mapid"), {
                center: { lat: 23.5154183, lng: 80.3135954 },
                zoom: 4,
                mapTypeId: "roadmap",
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false
            });

            //var firstLatLng  = { lat: parseFloat(pinged_locations[0]['lat']), lng: parseFloat(pinged_locations[0]['lng']) };
            /*const center = new google.maps.LatLng(parseFloat(pinged_locations[0]['lat']), pinged_locations[0]['lng']);
            window.map.panTo(center);
            window.map.setZoom(4);*/

            for (i = 0; i < pinged_locations.length; i++) {
                const myLatLng = { lat: parseFloat(pinged_locations[i]['lat']), lng: parseFloat((pinged_locations[i]['lng'])) };
                // If first location, then set colour as green
                if (i == 0) {
                    const svgMarker = {
                        path: "M10.453 14.016l6.563-6.609-1.406-1.406-5.156 5.203-2.063-2.109-1.406 1.406zM12 2.016q2.906 0 4.945 2.039t2.039 4.945q0 1.453-0.727 3.328t-1.758 3.516-2.039 3.070-1.711 2.273l-0.75 0.797q-0.281-0.328-0.75-0.867t-1.688-2.156-2.133-3.141-1.664-3.445-0.75-3.375q0-2.906 2.039-4.945t4.945-2.039z",
                        fillColor: "green",
                        fillOpacity: 1,
                        strokeWeight: 0,
                        rotation: 0,
                        scale: 2,
                        anchor: new google.maps.Point(15, 30),
                    };
                    // Add address as title and bindtooltp for showing location sequentially
                    var marker = new google.maps.Marker({
                        map,
                        icon: svgMarker,
                        title: pinged_locations[i]['address'],
                        position: myLatLng,
                        address: pinged_locations[i]['address'],
                        // rating: place.rating
                    });

                    markers.push(
                        marker
                    );
                    // Add latlng to bound for fitting the map within bounds
                    bounds.extend(myLatLng);
                }
                // If last location, then set colour as red
                else if (i == pinged_locations.length - 1) {
                    const svgMarker = {
                        path: "M10.453 14.016l6.563-6.609-1.406-1.406-5.156 5.203-2.063-2.109-1.406 1.406zM12 2.016q2.906 0 4.945 2.039t2.039 4.945q0 1.453-0.727 3.328t-1.758 3.516-2.039 3.070-1.711 2.273l-0.75 0.797q-0.281-0.328-0.75-0.867t-1.688-2.156-2.133-3.141-1.664-3.445-0.75-3.375q0-2.906 2.039-4.945t4.945-2.039z",
                        fillColor: "red",
                        fillOpacity: 1,
                        strokeWeight: 0,
                        rotation: 0,
                        scale: 2,
                        anchor: new google.maps.Point(15, 30),
                    };
                    // Add address as title and bindtooltp for showing location sequentially
                    var marker = new google.maps.Marker({
                        map,
                        icon: svgMarker,
                        // icon,
                        title: pinged_locations[i]['address'],
                        position: myLatLng,
                        address: pinged_locations[i]['address'],
                        // rating: place.rating
                    });

                    markers.push(
                        marker
                    );
                    // Add latlng to bound for fitting the map within bounds
                    bounds.extend(myLatLng);

                    // Create start latlng with last fetched location
                    startLatLng = new google.maps.LatLng(parseFloat(pinged_locations[i]['lat']), parseFloat(pinged_locations[i]['lng']));
                    // Create end latlng with actual destination lat and long
                    endLatLng = new google.maps.LatLng(parseFloat(endLocationLat), parseFloat(endLocationLong));
                    // Calculate distance between the last fetched location & actual destination
                    let distance = getDistanceInMeters(myLatLng, endLatLng);

                    // If distance is less than the defined distance to stop tracking, stop the tracking
                    if (distance <= DISTANCE_TO_STOP_TRACKING) {
                        stopTracking();
                    }
                }
                // Set colour as blue for remaining markers
                else {
                    const svgMarker = {
                        path: "M10.453 14.016l6.563-6.609-1.406-1.406-5.156 5.203-2.063-2.109-1.406 1.406zM12 2.016q2.906 0 4.945 2.039t2.039 4.945q0 1.453-0.727 3.328t-1.758 3.516-2.039 3.070-1.711 2.273l-0.75 0.797q-0.281-0.328-0.75-0.867t-1.688-2.156-2.133-3.141-1.664-3.445-0.75-3.375q0-2.906 2.039-4.945t4.945-2.039z",
                        fillColor: "blue",
                        fillOpacity: 1,
                        strokeWeight: 0,
                        rotation: 0,
                        scale: 2,
                        anchor: new google.maps.Point(15, 30),
                    };
                    // Add address as title and bindtooltp for showing location sequentially
                    var marker = new google.maps.Marker({
                        map,
                        icon: svgMarker,
                        // icon,
                        title: pinged_locations[i]['address'],
                        position: myLatLng,
                        address: pinged_locations[i]['address'],
                        // rating: place.rating
                    });

                    markers.push(
                        marker
                    );
                    // Add latlng to bound for fitting the map within bounds
                    bounds.extend(myLatLng);
                }
            }

            map.fitBounds(bounds);

            // Connecting the dots
            var flightPath = new google.maps.Polyline({
                path: flightPlanCoordinates,
                strokeColor: "#0000FF",
                strokeOpacity: 1.0,
                strokeWeight: 2
            });

            // Adding it to the map
            flightPath.setMap(map);
        }

        function getDistanceInMeters(location1, location2) {
            var distance = (google.maps.geometry.spherical.computeDistanceBetween(location1, location2) / 1000).toFixed(2);
            return distance;
        }

        function stopTracking() {
            // Generate a new token if token is empty
            if (token == null || token == "") {
                getToken(null, null, null);
            } else {
                $.ajax({
                    type: "GET",
                    beforeSend: function (request) {
                        request.setRequestHeader("Authorization", "bearer " + token);
                        showLoader();
                    },
                    url: BASE_URL + ENDPOINT_STOP_USER_TRACKING + mobileNumber,
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    success: function (response) {
                        hideLoader();

                        if (response == null) {
                            alert(ERROR_RESPONSE_NULL)
                        } else {
                            if (response['code'] == API_SUCCESS_CODE) {
                                alert(SUCCESS_STOPPING_TRACKING);
                            } else {
                                if (response['responseJSON']['message'] != null && response['responseJSON']['message'] != "") {
                                    alert(response['responseJSON']['message'])
                                } else {
                                    alert(ERROR_STOPPING_TRACKING)
                                }
                            }
                        }
                    },
                    error: function (response) {
                        hideLoader()

                        if (response['responseJSON']['message'] != null && response['responseJSON']['message'] != "") {
                            alert(response['responseJSON']['message'])
                        } else {
                            alert(ERROR_STOPPING_TRACKING)
                        }
                    }
                });
            }
        }
    </script>
</body>

<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAL7VxK8eW8-f2w_bzSeynTSPX941Msx9c&libraries=places&callback=view_map_view"
    type="text/javascript">
    </script>

</html>