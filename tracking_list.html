<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Trip Tracking</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" type="text/css" href="css/nav.css">
    <link rel="stylesheet" type="text/css" href="css/spinner.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <script src="js/jquery/jquery.js"></script>
    <script src="js/urls.js"></script>
    <script src="js/config.js"></script>
    <script src="js/error_messages.js"></script>
    <script src="js/essential_methods.js"></script>
    <script src="js/success_messages.js"></script>
    <script src="js/constants.js"></script>

    <style>
        ul {
            padding: 0;
            list-style-type: none;
        }

        #list_loading {
            display: none;
            text-align: center;
        }

        .search {
            width: 100%;
            position: relative;
            display: flex;
        }

        .searchTerm {
            width: 100%;
            border: 1px solid lightgrey;
            border-right: none;
            padding: 5px;
            height: 36px;
            margin-left: 10px;
            border-radius: 5px 0 0 5px;
            outline: none;
            color: black;
        }

        .searchTerm:focus {
            color: grey;
        }

        .searchButton {
            width: 40px;
            height: 36px;
            border: 1px solid lightgrey;
            background: #5FA744;
            text-align: center;
            color: #fff;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
            font-size: 20px;
            margin-right: 10px;
        }

        body {
            overflow-y: scroll;
        }

        /*#scroll_content {
            overflow-y: scroll;
            -webkit-overflow-scrolling: touch;
        }*/
    </style>

</head>

<body>
    <div id="spinner">
        <img src="images/loader.gif" />
    </div>

    <main class="main-container">
        <section class="p-2 p-md-3 p-lg-5">
            <div class="container">
                <div class="row no-gutters justify-content-center">
                    <div class="col-12 col-lg-10">
                        <div class="row no-gutters">
                            <div class="col-12 col-lg-12">
                                <h1 class="tx-bold tx-center header-title">Track Trip</h1>
                            </div>

                            <div class="search">
                                <input id="input_search_driver" type="text" class="searchTerm"
                                    placeholder="Search Driver Name / Mobile">
                                <button id="button_search_driver" type="submit" class="searchButton">
                                    <i class="fa fa-search"></i>
                                </button>
                            </div>

                            <div id="scroll_content" class="col-12 col-lg-12">
                                <ul id="tracking_list" style="list-style-type: none; margin-left: 0%;"></ul>

                                <p id="list_loading">
                                    <img src="images/loader.gif" alt="Loadingâ€¦" />
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
        </section>
        <button type="button" class="btn btn-success get-consent-btn" onclick="location.href = 'add_tracking.html';"><i
                class="fas fa-plus fa-2x"></i></button>
    </main>

    <nav class="nav" hidden>
        <a href="tracking_list.html" class="nav__link nav__link--active">
            <i class="material-icons nav__icon">drive_eta</i>
            <span class="nav__text">Trips</span>
        </a>
        <a href="driver_list.html" class="nav__link">
            <i class="material-icons nav__icon">groups</i>
            <span class="nav__text">Drivers</span>
        </a>
    </nav>
</body>

<script>
    // TODO : Hardcoded franchise id to be replaced by the franchise id passed through ninjacart app
    //let franchise_id = 'FOY0320';

    var offset = 0;
    var search_value = ""

    $(document).ready(function () {
        callGetAllTrackingEntries(FRANCHISE_ID, offset, search_value)
        var win = $(window);

        let scrollY = window.scrollY;
        let innerHeight = window.innerHeight;
        let offsetHeight = document.body.offsetHeight;

        if (scrollY + innerHeight > offsetHeight - 100) {
            offset = offset + 5
            callGetAllTrackingEntries(FRANCHISE_ID, offset, search_value)
        }
    });

    $('#button_search_driver').on('click', function (e) {
        e.preventDefault();

        let search_value = $('#input_search_driver').val()

        if (search_value == null || search_value == "") {
            $('#tracking_list').empty()
            offset = 0;
            search_value = ""
            callGetAllTrackingEntries(FRANCHISE_ID, offset, search_value)
            window.location.reload();
        } else {
            $('#tracking_list').empty()
            offset = 0;
            callGetAllTrackingEntries(FRANCHISE_ID, offset, search_value)
        }
    });

    function callGetAllTrackingEntries(received_franchise_id, received_offset, received_search_value) {
        $.ajax({
            type: "POST",
            url: BASE_URL + ENDPOINT_GET_ALL_TRACKING_ENTRIES,
            data: JSON.stringify({
                "franchise_id": received_franchise_id,
                "offset": received_offset,
                "search_value": received_search_value,
                "limit": 5
            }, function (k, v) { return v === undefined ? null : v; }),
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            beforeSend: function () {
                $('#list_loading').show();
            },
            success: function (response) {
                $('#list_loading').hide();

                if (response != null && response['code'] == '000') {
                    var response_rows = response['rows'];

                    if (response_rows.length > 0) {
                        for (index in response_rows) {
                            let start_location_name = response_rows[index]['start_location_name']
                            start_location_name = start_location_name.split(',')[0];

                            let end_location_name = response_rows[index]['end_location_name']
                            end_location_name = end_location_name.split(',')[0];

                            let location_name = start_location_name + '&emsp; <i class="fa fa-arrow-circle-right" style="color:green"></i> &emsp;' + end_location_name

                            let driver_details = response_rows[index]['name'] + " | " + response_rows[index]['mobile_number']

                            let consignment_number = response_rows[index]['consignment_number']
                            let vehicle_number = response_rows[index]['vehicle_number']

                            let end_location_lat = response_rows[index]['end_latitude'];
                            let end_location_long = response_rows[index]['end_longitude'];

                            createCard(location_name, driver_details, response_rows[index]['mobile_number'], consignment_number, vehicle_number, end_location_lat, end_location_long)
                        }
                    }
                } else {

                }
            },
            error: function (response) {
                $('#list_loading').hide();

                if (response['responseJSON']['message'] != null && response['responseJSON']['message'] != "") {
                     alert(response['responseJSON']['message'])
                } else {
                    alert(ERROR_GETTING_TRACKING_LIST)
                }
            }
        });
    }

    function createCard(location_name, driver_details, mobile_number, consignment_number, vehicle_number, end_location_lat, end_location_long) {
        console.log(`end_location_lat : ${end_location_lat}, end_location_long : ${end_location_long}`);

        const divCard = document.createElement('div');
        divCard.className = 'card'
        divCard.style = 'margin : 10px;'
        if(consignment_number == null || consignment_number == ""){
            consignment_number = "NA"
        }
        if(vehicle_number == null || vehicle_number == ""){
            vehicle_number = "NA"
        }

        divCard.innerHTML = `<div class="card-body" id >
            <h6 class="card-title">${location_name}</h6>
            <h6 class="card-subtitle mb-2 text-muted">${driver_details}</h6>
            <h6 class="card-text mb-2 text-muted">Consignment Number : ${consignment_number}</h6>
            <h6 class="card-text mb-2 text-muted">Vehicle Number : ${vehicle_number}</h6>
            <a href="tracking_details.html?mobile_number=${mobile_number}&end_location_lat=${end_location_lat}&end_location_long=${end_location_long}" class="card-link">Track <i class="fa fa-location-arrow" style="color:#007BFF"></i></a>
        </div>`

        $('#tracking_list').append(divCard);
    }

    function reroute(mobile_number) {
        window.location.href = `tracking-details.html?mobile_number=${mobile_number}`;
    }
</script>

</html>